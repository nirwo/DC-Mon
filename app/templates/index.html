{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Import Data</h5>
                </div>
                <div class="card-body">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#importModal">Import</button>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTeamModal">Add Team</button>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addApplicationModal">Add Application</button>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSystemModal">Add System</button>
                </div>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="applications-tab" data-bs-toggle="tab" href="#applications" role="tab">Applications</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="systems-tab" data-bs-toggle="tab" href="#systems" role="tab">Systems</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="teams-tab" data-bs-toggle="tab" href="#teams-table" role="tab">Teams</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="applications-table-tab" data-bs-toggle="tab" href="#applications-table" role="tab">Applications Table</a>
        </li>
        <li class="nav-item">
            <button class="btn btn-outline-primary ms-2" data-bs-toggle="modal" data-bs-target="#importModal">
                <i class="bi bi-upload"></i> Import
            </button>
        </li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="applications" role="tabpanel">
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Not Started</h5>
                        </div>
                        <div class="card-body" id="notStartedList" ondrop="drop(event)" ondragover="allowDrop(event)">
                            {% for app in applications %}
                            {% if app.state == 'notStarted' %}
                            <div class="card mb-2 application-card" id="app-{{ app._id }}" draggable="true" ondragstart="drag(event)">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1">{{ app.name }}</h6>
                                            <small>Team: {{ app.team.name }}</small>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="toggle-{{ app._id }}" {% if app.enabled %}checked{% endif %} onchange="toggleApplication('{{ app._id }}')">
                                        </div>
                                        <button class="btn btn-danger btn-sm" onclick="deleteApplication('{{ app._id }}')">Delete</button>
                                        <button class="btn btn-primary btn-sm" onclick="runTest('{{ app._id }}')">Run Test</button>
                                    </div>
                                    {% if app.systems %}
                                    <div class="mt-2">
                                        <small class="text-muted">Systems:</small>
                                        {% for system in app.systems %}
                                        <div class="d-flex justify-content-between align-items-center mt-1">
                                            <span class="small">{{ system.name }}</span>
                                            {% if system.webui_url %}
                                            <a href="{{ system.webui_url }}" target="_blank" class="system-url">ðŸ”—</a>
                                            {% endif %}
                                            {% if system.port %}
                                            <span class="port-badge">:{{ system.port }}</span>
                                            {% endif %}
                                            <span class="badge bg-{{ 'success' if system.status == 'running' else 'secondary' }}">
                                                {{ system.status }}
                                            </span>
                                            <button class="btn btn-danger btn-sm" onclick="deleteSystem('{{ system.id }}')">Delete</button>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="mt-2">
                                        <small class="text-muted">Sequence:</small>
                                        <span class="small">{{ app.sequence }}</span>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">Shutdown Order:</small>
                                        <span class="small">{{ app.shutdown_order }}</span>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">Dependencies:</small>
                                        {% if app.dependencies %}
                                        <ul class="dependencies-list">
                                            {% for dep in app.dependencies %}
                                            <li>{{ dep }}</li>
                                            {% endfor %}
                                        </ul>
                                        {% endif %}
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">Test Status:</small>
                                        <td class="test-status"></td>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">In Progress</h5>
                        </div>
                        <div class="card-body" id="inProgressList" ondrop="drop(event)" ondragover="allowDrop(event)">
                            {% for app in applications %}
                            {% if app.state == 'inProgress' %}
                            <div class="card mb-2 application-card" id="app-{{ app._id }}" draggable="true" ondragstart="drag(event)">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1">{{ app.name }}</h6>
                                            <small>Team: {{ app.team.name }}</small>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="toggle-{{ app._id }}" {% if app.enabled %}checked{% endif %} onchange="toggleApplication('{{ app._id }}')">
                                        </div>
                                        <button class="btn btn-danger btn-sm" onclick="deleteApplication('{{ app._id }}')">Delete</button>
                                        <button class="btn btn-primary btn-sm" onclick="runTest('{{ app._id }}')">Run Test</button>
                                    </div>
                                    {% if app.systems %}
                                    <div class="mt-2">
                                        <small class="text-muted">Systems:</small>
                                        {% for system in app.systems %}
                                        <div class="d-flex justify-content-between align-items-center mt-1">
                                            <span class="small">{{ system.name }}</span>
                                            {% if system.webui_url %}
                                            <a href="{{ system.webui_url }}" target="_blank" class="system-url">ðŸ”—</a>
                                            {% endif %}
                                            {% if system.port %}
                                            <span class="port-badge">:{{ system.port }}</span>
                                            {% endif %}
                                            <span class="badge bg-{{ 'success' if system.status == 'running' else 'secondary' }}">
                                                {{ system.status }}
                                            </span>
                                            <button class="btn btn-danger btn-sm" onclick="deleteSystem('{{ system.id }}')">Delete</button>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="mt-2">
                                        <small class="text-muted">Sequence:</small>
                                        <span class="small">{{ app.sequence }}</span>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">Shutdown Order:</small>
                                        <span class="small">{{ app.shutdown_order }}</span>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">Dependencies:</small>
                                        {% if app.dependencies %}
                                        <ul class="dependencies-list">
                                            {% for dep in app.dependencies %}
                                            <li>{{ dep }}</li>
                                            {% endfor %}
                                        </ul>
                                        {% endif %}
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">Test Status:</small>
                                        <td class="test-status"></td>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Completed</h5>
                        </div>
                        <div class="card-body" id="completedList" ondrop="drop(event)" ondragover="allowDrop(event)">
                            {% for app in applications %}
                            {% if app.state == 'completed' %}
                            <div class="card mb-2 application-card" id="app-{{ app._id }}" draggable="true" ondragstart="drag(event)">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1">{{ app.name }}</h6>
                                            <small>Team: {{ app.team.name }}</small>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="toggle-{{ app._id }}" {% if app.enabled %}checked{% endif %} onchange="toggleApplication('{{ app._id }}')">
                                        </div>
                                        <button class="btn btn-danger btn-sm" onclick="deleteApplication('{{ app._id }}')">Delete</button>
                                        <button class="btn btn-primary btn-sm" onclick="runTest('{{ app._id }}')">Run Test</button>
                                    </div>
                                    {% if app.systems %}
                                    <div class="mt-2">
                                        <small class="text-muted">Systems:</small>
                                        {% for system in app.systems %}
                                        <div class="d-flex justify-content-between align-items-center mt-1">
                                            <span class="small">{{ system.name }}</span>
                                            {% if system.webui_url %}
                                            <a href="{{ system.webui_url }}" target="_blank" class="system-url">ðŸ”—</a>
                                            {% endif %}
                                            {% if system.port %}
                                            <span class="port-badge">:{{ system.port }}</span>
                                            {% endif %}
                                            <span class="badge bg-{{ 'success' if system.status == 'running' else 'secondary' }}">
                                                {{ system.status }}
                                            </span>
                                            <button class="btn btn-danger btn-sm" onclick="deleteSystem('{{ system.id }}')">Delete</button>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="mt-2">
                                        <small class="text-muted">Sequence:</small>
                                        <span class="small">{{ app.sequence }}</span>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">Shutdown Order:</small>
                                        <span class="small">{{ app.shutdown_order }}</span>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">Dependencies:</small>
                                        {% if app.dependencies %}
                                        <ul class="dependencies-list">
                                            {% for dep in app.dependencies %}
                                            <li>{{ dep }}</li>
                                            {% endfor %}
                                        </ul>
                                        {% endif %}
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">Test Status:</small>
                                        <td class="test-status"></td>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="teams-table" role="tabpanel">
            <div class="teams-grid">
                <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4" id="teams-container">
                    <!-- Teams will be dynamically added here -->
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="systems" role="tabpanel">
            <div class="container mt-4" id="systemsContainer">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h5 class="card-title mb-0">Running Systems</h5>
                            </div>
                            <div id="running-systems" class="list-group list-group-flush">
                                <!-- Running systems will be populated here -->
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-secondary text-white">
                                <h5 class="card-title mb-0">Stopped Systems</h5>
                            </div>
                            <div id="stopped-systems" class="list-group list-group-flush">
                                <!-- Stopped systems will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="applications-table" role="tabpanel">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Application</th>
                            <th>Team</th>
                            <th>Systems</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="applications-container">
                        <!-- Applications will be dynamically added here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Team Modal -->
<div class="modal fade" id="addTeamModal" tabindex="-1" aria-labelledby="addTeamModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTeamModalLabel">Add New Team</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addTeamForm">
                    <div class="mb-3">
                        <label for="teamName" class="form-label">Team Name</label>
                        <input type="text" class="form-control" id="teamName" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createTeam()">Create Team</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Application Modal -->
<div class="modal fade" id="addApplicationModal" tabindex="-1" aria-labelledby="addApplicationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addApplicationModalLabel">Add New Application</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addApplicationForm">
                    <div class="mb-3">
                        <label for="appName" class="form-label">Application Name</label>
                        <input type="text" class="form-control" id="appName" required>
                    </div>
                    <div class="mb-3">
                        <label for="appTeam" class="form-label">Team</label>
                        <select class="form-select" id="appTeam" required>
                            {% for team in teams %}
                            <option value="{{ team._id }}">{{ team.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="shutdownOrder" class="form-label">Shutdown Order</label>
                        <input type="number" class="form-control" id="shutdownOrder" value="0">
                    </div>
                    <div class="mb-3">
                        <label for="dependencies" class="form-label">Dependencies (comma-separated)</label>
                        <input type="text" class="form-control" id="dependencies" placeholder="app1,app2">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createApplication()">Create Application</button>
            </div>
        </div>
    </div>
</div>

<!-- Add System Modal -->
<div class="modal fade" id="addSystemModal" tabindex="-1" aria-labelledby="addSystemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSystemModalLabel">Add New System</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addSystemForm">
                    <div class="mb-3">
                        <label for="systemHost" class="form-label">Host</label>
                        <input type="text" class="form-control" id="systemHost" required>
                    </div>
                    <div class="mb-3">
                        <label for="systemName" class="form-label">System Name (optional)</label>
                        <input type="text" class="form-control" id="systemName" placeholder="Will use host if not specified">
                    </div>
                    <div class="mb-3">
                        <label for="systemApp" class="form-label">Application</label>
                        <select class="form-select" id="systemApp" required>
                            {% for app in applications %}
                            <option value="{{ app._id }}">{{ app.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="systemPort" class="form-label">Port</label>
                        <input type="number" class="form-control" id="systemPort">
                    </div>
                    <div class="mb-3">
                        <label for="systemWebUI" class="form-label">WebUI URL</label>
                        <input type="url" class="form-control" id="systemWebUI">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createSystem()">Create System</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Team Modal -->
<div class="modal fade" id="editTeamModal" tabindex="-1" aria-labelledby="editTeamModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTeamModalLabel">Edit Team</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editTeamId">
                <div class="mb-3">
                    <label for="editTeamName" class="form-label">Team Name</label>
                    <input type="text" class="form-control" id="editTeamName" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="updateTeam()">Save changes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="importStatus"></div>
                <form id="importForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="file" class="form-label">CSV File</label>
                        <input type="file" class="form-control" id="file" name="file" accept=".csv" required>
                        <small class="text-muted">
                            Required columns: team, application, system, host<br>
                            Optional: port, webui_url
                        </small>
                    </div>
                    <button type="submit" class="btn btn-primary">Import</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="alertContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;">
    <!-- Alerts will be inserted here -->
</div>

<style>
:root {
    --color-completed: #e3f5e9;
    --color-completed-border: #4ade80;
    --color-in-progress: #e0f2fe;
    --color-in-progress-border: #38bdf8;
    --color-not-started: #f1f5f9;
    --color-not-started-border: #94a3b8;
    --transition-speed: 0.3s;
}

body {
    background-color: #f8fafc;
}

.nav-tabs {
    border-bottom: none;
    margin-bottom: 1.5rem;
}

.nav-tabs .nav-link {
    color: #64748b;
    border: none;
    padding: 0.75rem 1rem;
    margin-right: 0.5rem;
    transition: all var(--transition-speed) ease;
}

.nav-tabs .nav-link:hover {
    color: #0f172a;
    background-color: #f1f5f9;
    border-radius: 0.5rem;
}

.nav-tabs .nav-link.active {
    color: #0f172a;
    font-weight: 600;
    background-color: #e0f2fe;
    border-radius: 0.5rem;
}

.tab-content {
    animation: fadeIn 0.3s ease;
}

.card {
    border: none;
    border-radius: 1rem;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    transition: transform var(--transition-speed) ease;
}

.card:hover {
    transform: translateY(-2px);
}

.system-row {
    padding: 1.25rem;
    margin-bottom: 1rem;
    border-radius: 0.75rem;
    transition: all var(--transition-speed) ease;
}

.system-row.running {
    background-color: var(--color-completed);
    border: 1px solid var(--color-completed-border);
}

.system-row.stopped {
    background-color: var(--color-not-started);
    border: 1px solid var(--color-not-started-border);
}

.system-row.unknown {
    background-color: var(--color-in-progress);
    border: 1px solid var(--color-in-progress-border);
}

.status-badge {
    padding: 0.35rem 0.75rem;
    border-radius: 2rem;
    font-size: 0.875rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.status-badge.running {
    background-color: var(--color-completed);
    color: #166534;
}

.status-badge.stopped {
    background-color: var(--color-not-started);
    color: #475569;
}

.status-badge.unknown {
    background-color: var(--color-in-progress);
    color: #0369a1;
}

.status-badge i {
    font-size: 0.75rem;
}

.btn {
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-weight: 500;
    transition: all var(--transition-speed) ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn i {
    font-size: 1.1em;
}

.btn-primary {
    background-color: #0ea5e9;
    border-color: #0ea5e9;
}

.btn-primary:hover {
    background-color: #0284c7;
    border-color: #0284c7;
}

.btn-outline-primary {
    color: #0ea5e9;
    border-color: #0ea5e9;
}

.btn-outline-primary:hover {
    background-color: #0ea5e9;
    border-color: #0ea5e9;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes slideIn {
    from { transform: translateX(-20px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.system-row {
    animation: slideIn 0.3s ease;
}

[data-bs-toggle="tooltip"] {
    cursor: help;
}

.teams-grid {
    margin: -0.5rem;
}

.team-card {
    height: 100%;
    transition: all var(--transition-speed) ease;
}

.team-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 12px -4px rgba(0,0,0,0.1);
}

.section-title {
    font-size: 0.875rem;
    color: #64748b;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
}

.section-title i {
    font-size: 1em;
}

.apps-list, .systems-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.app-item, .system-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    background: var(--color-not-started);
    border-radius: 0.5rem;
    font-size: 0.875rem;
}

.system-item {
    background: transparent;
    border: 1px solid var(--color-not-started-border);
}

.system-item .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.status-dot.running { background-color: var(--color-completed-border); }
.status-dot.stopped { background-color: var(--color-not-started-border); }
.status-dot.unknown { background-color: var(--color-in-progress-border); }

.systems-preview {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.system-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid transparent;
}

.system-dot.running {
    background-color: var(--color-completed);
    border-color: var(--color-completed-border);
}

.system-dot.stopped {
    background-color: var(--color-not-started);
    border-color: var(--color-not-started-border);
}

.system-dot.unknown {
    background-color: var(--color-in-progress);
    border-color: var(--color-in-progress-border);
}

.more-systems {
    font-size: 0.75rem;
    color: #64748b;
    background: var(--color-not-started);
    padding: 0.25rem 0.5rem;
    border-radius: 1rem;
}

.table > :not(caption) > * > * {
    padding: 1rem;
}

.table tbody tr {
    transition: all var(--transition-speed) ease;
}

.table tbody tr:hover {
    background-color: var(--color-not-started);
}
</style>

<script>
// Alert handling
function showAlert(type, message, duration = 5000) {
    const alertContainer = document.getElementById('alertContainer');
    const alertId = 'alert-' + Date.now();
    const alertHtml = `
        <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert" style="min-width: 300px; max-width: 500px;">
            <pre style="margin: 0; white-space: pre-wrap;">${message}</pre>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    
    alertContainer.insertAdjacentHTML('beforeend', alertHtml);
    
    // Auto dismiss after duration
    if (duration > 0) {
        setTimeout(() => {
            const alertElement = document.getElementById(alertId);
            if (alertElement) {
                const bsAlert = new bootstrap.Alert(alertElement);
                bsAlert.close();
            }
        }, duration);
    }
}

function deleteTeam(teamId) {
    if (!confirm('Are you sure you want to delete this team?')) {
        return;
    }
    
    fetch(`/api/teams/${teamId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'Team deleted successfully');
            loadTeams();
        } else {
            showAlert('danger', 'Failed to delete team: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'Failed to delete team');
    });
}

function editTeam(teamId) {
    const teamName = document.querySelector(`tr[data-team-id="${teamId}"] td:first-child`).textContent;
    document.getElementById('editTeamId').value = teamId;
    document.getElementById('editTeamName').value = teamName;
    const modal = new bootstrap.Modal(document.getElementById('editTeamModal'));
    modal.show();
}

function updateTeam() {
    const teamId = document.getElementById('editTeamId').value;
    const teamName = document.getElementById('editTeamName').value;
    
    fetch(`/api/teams/${teamId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            name: teamName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'Team updated successfully');
            const modal = bootstrap.Modal.getInstance(document.getElementById('editTeamModal'));
            modal.hide();
            loadTeams();
        } else {
            showAlert('danger', 'Failed to update team: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'Failed to update team');
    });
}

function deleteApplication(appId) {
    if (!confirm('Are you sure you want to delete this application and all its systems?')) {
        return;
    }
    
    fetch(`/api/applications/${appId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'Application deleted successfully');
            loadApplications();
        } else {
            showAlert('danger', 'Failed to delete application: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'Failed to delete application');
    });
}

function deleteSystem(systemId) {
    if (!confirm('Are you sure you want to delete this system?')) {
        return;
    }
    
    fetch(`/api/systems/${systemId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'System deleted successfully');
            loadSystems();
        } else {
            showAlert('danger', 'Failed to delete system: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'Failed to delete system');
    });
}

function allowDrop(ev) {
    ev.preventDefault();
}

function drag(ev) {
    ev.dataTransfer.setData("text", ev.target.id);
}

function drop(ev) {
    ev.preventDefault();
    var data = ev.dataTransfer.getData("text");
    var draggedElement = document.getElementById(data);
    var targetList = ev.target.closest('[id$="List"]');
    if (targetList) {
        targetList.appendChild(draggedElement);
        updateApplicationState(data.split('-')[1], targetList.id.replace('List', ''));
    }
}

function updateApplicationState(appId, state) {
    fetch(`/api/applications/${appId}/state`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({state: state})
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        }
    });
}

function toggleApplication(appId) {
    const toggle = document.getElementById(`toggle-${appId}`);
    fetch(`/api/applications/${appId}/toggle`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({enabled: toggle.checked})
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            toggle.checked = !toggle.checked;
        }
    });
}

function createTeam() {
    const teamName = document.getElementById('teamName').value;
    
    fetch('/api/teams', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            name: teamName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'Team created successfully');
            const modal = bootstrap.Modal.getInstance(document.getElementById('addTeamModal'));
            modal.hide();
            const teamsTab = document.getElementById('teams-tab');
            if (teamsTab) {
                teamsTab.click();
            }
        } else {
            showAlert('danger', 'Failed to create team: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'Failed to create team');
    });
}

function createApplication() {
    const appName = document.getElementById('appName').value;
    const teamId = document.getElementById('appTeam').value;
    const shutdownOrder = document.getElementById('shutdownOrder').value;
    const dependencies = document.getElementById('dependencies').value.split(',').filter(d => d.trim());
    
    fetch('/api/applications/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            name: appName,
            team_id: teamId,
            shutdown_order: shutdownOrder,
            dependencies: dependencies
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'Application created successfully');
            const modal = bootstrap.Modal.getInstance(document.getElementById('addApplicationModal'));
            modal.hide();
            const appsTab = document.getElementById('applications-tab');
            if (appsTab) {
                appsTab.click();
            }
        } else {
            showAlert('danger', 'Failed to create application: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'Failed to create application');
    });
}

function createSystem() {
    const host = document.getElementById('systemHost').value;
    const name = document.getElementById('systemName').value;
    const appId = document.getElementById('systemApp').value;
    const port = document.getElementById('systemPort').value;
    const webui = document.getElementById('systemWebUI').value;
    
    fetch('/api/systems', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            host: host,
            name: name || host,
            application_id: appId,
            port: port,
            webui_url: webui
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'System created successfully');
            const modal = bootstrap.Modal.getInstance(document.getElementById('addSystemModal'));
            modal.hide();
            const systemsTab = document.getElementById('systems-tab');
            if (systemsTab) {
                systemsTab.click();
            }
        } else {
            showAlert('danger', 'Failed to create system: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'Failed to create system');
    });
}

function updateSystemStatus(systemId) {
    fetch(`/api/systems/${systemId}/status`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const statusCell = document.querySelector(`tr[data-system-id="${systemId}"] .status-cell`);
            const statusSwitch = document.querySelector(`tr[data-system-id="${systemId}"] .status-switch`);
            if (statusCell) {
                statusCell.textContent = data.status;
                if (statusSwitch) {
                    statusSwitch.checked = data.status === 'running';
                }
            }
        }
    })
    .catch(error => {
        console.error('Error updating systems:', error);
        showAlert('danger', 'Failed to update systems status');
    });
}

function toggleSystemStatus(systemId, element) {
    const newStatus = element.checked ? 'running' : 'stopped';
    
    fetch(`/api/systems/${systemId}/status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showAlert('success', `System ${newStatus}`);
            updateSystemsList(); // Refresh the list
        } else {
            element.checked = !element.checked;
            showAlert('danger', 'Failed to update system status');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        element.checked = !element.checked;
        showAlert('danger', 'Failed to update system status');
    });
}

function updateSystemsList() {
    fetch('/api/systems')
        .then(response => response.json())
        .then(systems => {
            const runningSystems = document.getElementById('running-systems');
            const stoppedSystems = document.getElementById('stopped-systems');
            const unknownSystems = document.getElementById('unknown-systems');
            
            if (runningSystems) runningSystems.innerHTML = '';
            if (stoppedSystems) stoppedSystems.innerHTML = '';
            if (unknownSystems) unknownSystems.innerHTML = '';
            
            systems.forEach(system => {
                const statusText = {
                    'running': '<i class="bi bi-check-circle-fill"></i> Running',
                    'stopped': '<i class="bi bi-stop-circle-fill"></i> Stopped',
                    'unknown': '<i class="bi bi-question-circle-fill"></i> Unknown'
                }[system.status];
                
                const systemHtml = `
                    <div class="system-row ${system.status}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">
                                    ${system.name}
                                    <span class="status-badge ${system.status}" data-bs-toggle="tooltip" title="Last updated: ${new Date(system.last_checked).toLocaleString()}">
                                        ${statusText}
                                    </span>
                                </h5>
                                <div class="text-muted">
                                    <small class="d-block">Host: ${system.host}</small>
                                    ${system.port ? `<small class="d-block">Port: ${system.port}</small>` : ''}
                                </div>
                            </div>
                            <div class="d-flex align-items-center gap-3">
                                ${system.webui_url ? `
                                    <a href="${system.webui_url}" target="_blank" class="btn btn-outline-primary btn-sm" data-bs-toggle="tooltip" title="Open system web interface">
                                        <i class="bi bi-box-arrow-up-right"></i>
                                        Web UI
                                    </a>
                                ` : ''}
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" 
                                        ${system.status === 'running' ? 'checked' : ''} 
                                        data-bs-toggle="tooltip"
                                        title="${system.status === 'running' ? 'Stop system' : 'Start system'}"
                                        onchange="toggleSystemStatus('${system.id}', this)">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                if (system.status === 'running') {
                    if (runningSystems) runningSystems.insertAdjacentHTML('beforeend', systemHtml);
                } else if (system.status === 'stopped') {
                    if (stoppedSystems) stoppedSystems.insertAdjacentHTML('beforeend', systemHtml);
                } else {
                    if (unknownSystems) unknownSystems.insertAdjacentHTML('beforeend', systemHtml);
                }
            });
            
            // Reinitialize tooltips for new elements
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function(tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        })
        .catch(error => {
            console.error('Error updating systems:', error);
            showAlert('danger', 'Failed to update systems status');
        });
}

function runTest(appId) {
    const button = document.querySelector(`button[onclick="runTest('${appId}')"]`);
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Running...';

    fetch(`/api/applications/${appId}/test`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('info', 'Test started. Please wait...', 0);
            pollTestStatus(appId);
        } else {
            showAlert('danger', `Failed to start test: ${data.error}`, 0);
            button.disabled = false;
            button.textContent = 'Run Test';
        }
    })
    .catch(error => {
        console.error('Test error:', error);
        showAlert('danger', 'Failed to start test', 0);
        button.disabled = false;
        button.textContent = 'Run Test';
    });
}

function pollTestStatus(appId, interval = 2000) {
    const button = document.querySelector(`button[onclick="runTest('${appId}')"]`);
    const statusCell = document.querySelector(`tr[data-app-id="${appId}"] td.test-status`);

    fetch(`/api/applications/${appId}/test/status`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (statusCell) {
                    let statusHtml = `<span class="badge bg-${getStatusBadgeClass(data.status)}">${data.status}</span>`;
                    if (data.results) {
                        statusHtml += '<br><small class="text-muted">' + 
                            data.results.map(r => `${r.name}: ${r.passed ? 'âœ“' : 'âœ—'}`).join(', ') +
                            '</small>';
                    }
                    statusCell.innerHTML = statusHtml;
                }

                if (data.job_status === 'pending' || data.job_status === 'running') {
                    setTimeout(() => pollTestStatus(appId, interval), interval);
                } else {
                    button.disabled = false;
                    button.textContent = 'Run Test';

                    if (data.job_status === 'completed') {
                        if (data.status === 'passed') {
                            showAlert('success', 'Test completed successfully', 5000);
                        } else {
                            showAlert('warning', 'Test completed with failures', 0);
                        }
                    } else if (data.job_status === 'failed') {
                        showAlert('danger', 'Test failed to complete', 0);
                    }
                }
            } else {
                button.disabled = false;
                button.textContent = 'Run Test';
                showAlert('danger', `Failed to get test status: ${data.error}`, 0);
            }
        })
        .catch(error => {
            console.error('Status check error:', error);
            button.disabled = false;
            button.textContent = 'Run Test';
            showAlert('danger', 'Failed to check test status', 0);
        });
}

function getStatusBadgeClass(status) {
    switch (status) {
        case 'passed': return 'success';
        case 'failed': return 'danger';
        case 'pending': return 'warning';
        case 'running': return 'info';
        case 'error': return 'danger';
        default: return 'secondary';
    }
}

let updateInterval;

function startAutoUpdate() {
    // Initial update
    updateSystemsList();
    updateTeamsList();
    
    // Clear existing interval if any
    if (updateInterval) {
        clearInterval(updateInterval);
    }
    
    // Set new interval - update every 10 seconds
    updateInterval = setInterval(() => {
        updateSystemsList();
        updateTeamsList();
    }, 10000);
}

function updateTeamsList() {
    fetch('/api/teams')
        .then(response => response.json())
        .then(teams => {
            const container = document.getElementById('teams-container');
            if (!container) return;
            
            container.innerHTML = teams.map(team => {
                const systems = team.systems || [];
                const apps = team.applications || [];
                
                const systemsList = systems.slice(0, 5).map(sys => `
                    <div class="system-item">
                        <span class="status-dot ${sys.status}"></span>
                        ${sys.name}
                    </div>
                `).join('');
                
                const appsList = apps.slice(0, 5).map(app => `
                    <div class="app-item">
                        <i class="bi bi-app"></i>
                        ${app.name}
                    </div>
                `).join('');

                return `
                    <div class="col">
                        <div class="card team-card h-100">
                            <div class="card-body">
                                <h5 class="card-title d-flex justify-content-between align-items-center">
                                    ${team.name}
                                    <div class="team-stats">
                                        <span class="badge bg-primary" title="Applications">
                                            <i class="bi bi-grid"></i> ${apps.length}
                                        </span>
                                        <span class="badge bg-secondary" title="Systems">
                                            <i class="bi bi-pc"></i> ${systems.length}
                                        </span>
                                    </div>
                                </h5>
                                
                                ${apps.length > 0 ? `
                                    <div class="apps-section mt-3">
                                        <h6 class="section-title">
                                            <i class="bi bi-grid"></i> Applications
                                            ${apps.length > 5 ? `
                                                <small class="text-muted">(Showing 5 of ${apps.length})</small>
                                                <button class="btn btn-link btn-sm p-0" onclick="showAllApps('${team._id}')">
                                                    Show All
                                                </button>
                                            ` : ''}
                                        </h6>
                                        <div class="apps-list">
                                            ${appsList}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${systems.length > 0 ? `
                                    <div class="systems-section mt-3">
                                        <h6 class="section-title">
                                            <i class="bi bi-pc"></i> Systems
                                            ${systems.length > 5 ? `
                                                <small class="text-muted">(Showing 5 of ${systems.length})</small>
                                                <button class="btn btn-link btn-sm p-0" onclick="showAllSystems('${team._id}')">
                                                    Show All
                                                </button>
                                            ` : ''}
                                        </h6>
                                        <div class="systems-list">
                                            ${systemsList}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        });
}

function updateApplicationsList() {
    fetch('/api/applications')
        .then(response => response.json())
        .then(applications => {
            const container = document.getElementById('applications-container');
            if (!container) return;
            
            container.innerHTML = applications.map(app => {
                const systems = app.systems || [];
                const systemStatuses = systems.map(s => s.status);
                let overallStatus = 'unknown';
                
                if (systemStatuses.every(s => s === 'running')) {
                    overallStatus = 'running';
                } else if (systemStatuses.every(s => s === 'stopped')) {
                    overallStatus = 'stopped';
                } else if (systemStatuses.some(s => s === 'running')) {
                    overallStatus = 'partial';
                }

                return `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-grid me-2"></i>
                                <div>
                                    <div class="fw-500">${app.name}</div>
                                    <small class="text-muted">${systems.length} system${systems.length !== 1 ? 's' : ''}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            ${app.team ? `
                                <span class="badge bg-light text-dark">
                                    <i class="bi bi-people"></i> ${app.team.name}
                                </span>
                            ` : '-'}
                        </td>
                        <td>
                            <div class="systems-preview">
                                ${systems.slice(0, 3).map(sys => `
                                    <div class="system-dot ${sys.status}" 
                                         data-bs-toggle="tooltip" 
                                         title="${sys.name}: ${sys.status}">
                                    </div>
                                `).join('')}
                                ${systems.length > 3 ? `
                                    <span class="more-systems" 
                                          data-bs-toggle="tooltip" 
                                          title="${systems.slice(3).map(s => s.name).join(', ')}">
                                        +${systems.length - 3}
                                    </span>
                                ` : ''}
                            </div>
                        </td>
                        <td>
                            <span class="status-badge ${overallStatus}">
                                <i class="bi bi-${
                                    overallStatus === 'running' ? 'check-circle-fill' :
                                    overallStatus === 'stopped' ? 'stop-circle-fill' :
                                    overallStatus === 'partial' ? 'dash-circle-fill' :
                                    'question-circle-fill'
                                }"></i>
                                ${
                                    overallStatus === 'running' ? 'All Running' :
                                    overallStatus === 'stopped' ? 'All Stopped' :
                                    overallStatus === 'partial' ? 'Partially Running' :
                                    'Unknown'
                                }
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" 
                                    onclick="showApplicationDetails('${app._id}')"
                                    data-bs-toggle="tooltip"
                                    title="View application details">
                                <i class="bi bi-info-circle"></i>
                                Details
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Reinitialize tooltips
            const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            tooltips.forEach(el => new bootstrap.Tooltip(el));
        });
}

function showAllApps(teamId) {
    // Implement modal or expandable section for showing all apps
}

function showAllSystems(teamId) {
    // Implement modal or expandable section for showing all systems
}

function showApplicationDetails(appId) {
    // Implement modal for showing application details
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Update lists when tab is shown
    const tabElements = document.querySelectorAll('a[data-bs-toggle="tab"]');
    tabElements.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function (event) {
            const targetId = event.target.getAttribute('href');
            if (targetId === '#teams-table') {
                updateTeamsList();
            } else if (targetId === '#applications-table') {
                updateApplicationsList();
            } else if (targetId === '#systems') {
                updateSystemsList();
            }
        });
    });

    // Initial update for active tab
    const activeTab = document.querySelector('.nav-link.active');
    if (activeTab) {
        const targetId = activeTab.getAttribute('href');
        if (targetId === '#teams-table') {
            updateTeamsList();
        } else if (targetId === '#applications-table') {
            updateApplicationsList();
        } else if (targetId === '#systems') {
            updateSystemsList();
        }
    }
});
</script>

{% endblock %}

{% block scripts %}
{% endblock %}
